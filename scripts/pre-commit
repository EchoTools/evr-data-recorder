#!/bin/bash
# Pre-commit hook to run tests before committing
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    echo "Error: Not in a Go module directory"
    exit 1
fi

# Run go fmt check
echo "Checking formatting..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "The following files are not formatted:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run 'go fmt ./...' to fix."
    exit 1
fi

# Run go vet
echo "Running go vet..."
go vet ./...

# Run smoke tests (quick acceptance tests)
echo "Running smoke tests..."
go test -v -short -run "^TestCLI" ./cmd/agent/...

# Run unit tests (excluding known failing tests in other packages)
echo "Running unit tests..."
go test -short ./cmd/... ./internal/agent/... ./internal/config/...

echo "All pre-commit checks passed!"
